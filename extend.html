<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>CaptainHook Documentation</title>

    <link rel="icon" type="image/png" href="gfx/favicon.png">
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/layout.css" rel="stylesheet">
    <link href="css/darcula.css" rel="stylesheet">

    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>
  <body>
    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="https://github.com/captainhook-git/captainhook">
            <div class="logo-plus-title"><img src="gfx/captainhook.png" alt="CaptainHook" width="55" /> Captainhook</div>
          </a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav navbar-right">
            <li><a href="index.html">Home</a></li>
            <li><a href="install.html">Install</a></li>
            <li><a href="configure.html">Configure</a></li>
            <li><a href="hooks.html">Hooks</a></li>
            <li class="active"><a href="extend.html">Extend</a></li>
            <li><a href="https://shop.spreadshirt.de/captainhookphp/">Merch</a></li>
          </ul>
        </div>
      </div>
    </nav>

    <div class="container theme-showcase" role="main">

      <h1>Extending</h1>
      <p>
        You can extend CaptainHook with your own PHP classes, this requires you to configure your PHP classes
        with their fully qualified class names and you have to be sure that composer can autoload your classes.
        There are two ways of hooking your own PHP code in. Let's start with the simpler, yet not so powerful one.
      </p>
      <p>
        If you want to leverage other people's coding skills you can check the list of
        available <a href="#extensions">extensions</a>.
      </p>
      <h3 id="rules">Custom Rules</h3>
      <p>
        <em>CaptainHook</em> offers a thing called <em class="hl">RuleBook</em> to validate commit messages.
        All of CaptainHooks message validation is done using a <em>RuleBook</em>. For example the regular expression
        validation is using a <em>RuleBook</em> with a single rule called <em>MatchesRegularExpression</em>.
        But let's just look at an example.
      </p>
      <pre><code class="javascript">{
"commit-msg": {
  "enabled": true,
  "actions": [
    {
      "action": "\\CaptainHook\\App\\Hook\\Message\\Action\\Rules",
      "options": [
        "\\CaptainHook\\App\\Hook\Message\\Rule\\SubjectStartsWithCapitalLetter"
      ]
    }
  ]
}</code></pre>
      <p>
        The <em>Rules</em> action accepts a list of <em class="hl">Rule</em> classes and creates a <em>RuleBook</em>
        with all the given rules. You can write your own rules by implementing the
        <em class="hl">CaptainHook\App\Hook\Message\Rule</em> interface. Here is an example.
      </p>

      <pre><code class="php">&lt;?php
namespace MyName\GitHook;

use CaptainHook\App\Hooks\Message\Rule;
use SebastianFeldmann\Git\CommitMessage;

class DoNotYell implements Rule
{
    /**
     * Make sure nobody yells in commit messages.
     *
     * @param  \SebastianFeldmann\Git\CommitMessage $message
     * @return bool
     */
    public function pass(CommitMessage $message) : bool
    {
        return $message->getContent() !== strtoupper($message->getContent());
    }
}</code></pre>

      <p>
        With rules you can only validate your commit message. If you want to hook into other events like
        <em class="hl">pre-commit</em> or <em class="hl">pre-push</em> or you need more flexibility,
        then custom <em>Actions</em> are your thing.
      </p>

      <h3 id="actions">Custom Actions</h3>
      <p>
        Custom <em>Actions</em> allow you to execute your own logic on any git hook you want.
        Just like the built-in actions, you can define a list or map of options you want to pass to your class.
      </p>
      <p>
        You can either use a static method, or a custom <em>Action</em> class implementing the <em>Action</em> interface.
      </p>

      <h4>Static Method Call</h4>
      <pre><code class="javascript">{
  "pre-commit": {
    "enabled": true,
    "actions": [
      {
        "action": "\\MyName\\GitHook\\MyAction::execute"
      }
    ]
  }
}</code></pre>
      <p>
        This is most likely the easiest way to execute custom php code via git hook. But if you need access to the
        original hook arguments or some git status information I would recommend implementing a custom <em>Action</em>.
      </p>

      <h4>Custom Action Class</h4>
      <pre><code class="javascript">{
  "commit-msg": {
    "enabled": true,
    "actions": [
      {
        "action": "\\MyName\\GitHook\\MyValidator",
        "options": {
          "key": "value",
          "use": "what you need"
        }
      }
    ]
  }
}</code></pre>

      <p>
        The whole process is best explained with a "real-world" example.
        So let's assume you want to check if all ticket numbers in a commit message do exist in your issue tracker.
        All you have to do, is to create a PHP class like this.
      </p>

      <pre><code class="php">&lt;?php
namespace MyName\GitHook;

use CaptainHook\App\Config;
use CaptainHook\App\Console\IO;
use CaptainHook\App\Hook\Action;
use SebastianFeldmann\Git\Repository;

class TicketIDValidator implements Action
{
    /**
     * Execute the action.
     *
     * @param  \CaptainHook\App\Config           $config
     * @param  \CaptainHook\App\Console\IO       $io
     * @param  \SebastianFeldmann\Git\Repository $repository
     * @param  \CaptainHook\App\Config\Action    $action
       @return void
     * @throws \Exception
     */
    public function execute(Config $config, IO $io, Repository $repository, Config\Action $action) : void
    {
        $message = $repository->getCommitMsg();

        foreach ($this->findTicketIdsIn($message->getContent()) as $id) {
            if (!$this->isValidTicketId($id)) {
                throw new \Exception('invalid ticket ID: ' . $id);
            }
        }
    }

    /**
     * @param  string $text
     * @return array
     */
    private function findTicketIdsIn($text) : array
    {
        // put some logic here
    }

    /**
     * @param  string $id
     * @return bool
     */
    private function isValidTicketId($id) : bool
    {
        // put some logic here
    }
}</code></pre>

      <h3 id="conditions">Conditions</h3>

      <p>
        The only thing you have to do to write your own <em>Condition</em> is that you have to implement the <em>\CaptainHook\App\Hook\Condition</em> interface.
        That means that you have to implement one single method called <em>"isTrue"</em>
      </p>
      <p>
        Here is a minimal example.
      </p>

      <pre><code class="php">&lt;?php

namespace MyName\HookConditions;

use CaptainHook\App\Console\IO;
use CaptainHook\App\Hook\Condition;
use SebastianFeldmann\Git\Repository;

class NotOnMonday implements Condition
{
    /**
     * Make sure the action is not executed on mondays
     *
     * @param  \CaptainHook\App\Console\IO       $io
     * @param  \SebastianFeldmann\Git\Repository $repository
     * @return bool
     */
    public function isTrue(IO $io, Repository $repository) : bool
    {
        return date('D') !== 'Mon';
    }
}</code></pre>

      <p>To use this you can add this to any action configuration you want.</p>

      <pre><code class="javascript">{
  "pre-commit": {
    "enabled": true,
    "actions": [
      {
        "action": "\\MyName\\GitHook\\MyAction::execute",
        "conditions": [
          {
            "exec": "\\MyName\\HookConditions\\NotOnMonday"
          }
        ]
      }
    ]
  }
}</code></pre>

      <p>
        If you want to make the days of the week configurable, all you have to do is to add an constructor and configure the arguments you want to pass to the constructor.
      </p>

      <pre><code class="php">&lt;?php

namespace MyName\HookConditions;

use CaptainHook\App\Console\IO;
use CaptainHook\App\Hook\Condition;
use SebastianFeldmann\Git\Repository;

class NotOnAnyWeekday implements Condition
{
    /**
     * List of days where to not execute the action e.g. ['SAT', 'SUN']
     *
     * @var array
     */
    private $weekdays;

    /**
     * NotOnAnyWeekday constructor
     *
     * @param array $weekdays List of weekdays to skip e.g. ['MON', 'SAT']
     */
    public function __construct(array $weekdays)
    {
        $this->weekdays = $weekdays;
    }

    /**
     * Make sure this action is not executed on and configured weekdays
     *
     * @param  \CaptainHook\App\Console\IO       $io
     * @param  \SebastianFeldmann\Git\Repository $repository
     * @return bool
     */
    public function isTrue(IO $io, Repository $repository) : bool
    {
        return !in_array(date('D'), $this->weekdays);
    }
}</code></pre>

      <p>
        To setup the weekdays you would configure it like this. If you want to use multiple constructor arguments, just add them to the args array.
      </p>

      <pre><code class="javascript">{
  "pre-commit": {
    "enabled": true,
    "actions": [
      {
        "action": "\\MyName\\GitHook\\MyAction::execute",
        "conditions": [
          {
            "exec:"\\MyName\\HookConditions\\NotOnWeekday",
            "args": [
              ["Mon", "Sat"]
            ]
          }
        ]
      }
    ]
  }
}</code></pre>

      <h3 id="plugins">Plugins</h3>

      <p>
        <em>Actions</em> and <em>Conditions</em> are suitable for most needs, but there may be times you need to
        add more functionality to CaptainHook, such as performing tasks before or after a hook runs. CaptainHook's
        plugin system provides this flexibility!
      </p>

      <p>
        All CaptainHook plugins implement the <em class="hl">CaptainHook\App\Plugin\CaptainHook</em> interface. To use
        a plugin, add it to the <em class="hl">plugins</em> array in your config. If a plugin requires options, you may
        also provide those.
      </p>

      <pre><code class="javascript">{
  "config": {
    "plugins": [
      {
        "plugin": "\\MyName\\GitHook\\MyPlugin",
        "options": {
          "myOption": true,
          "stuff": "cool things"
        }
      }
    ]
  }
}</code></pre>

      <h4>Hook Plugins</h4>

      <p>
        Hook plugins are so-called because they execute during the hook run stage of CaptainHook, allowing you to
        do things before and after the hook runs, as well as before and after each action in the hook.
      </p>

      <p>
        To create a hook plugin, implement the <em class="hl">CaptainHook\App\Plugin\Hook</em> interface.
        Optionally, you may extend the <em class="hl">CaptainHook\App\Plugin\Hook\Base</em> abstract class, which
        provides some basic functionality.
      </p>

      <p>
        To see an example hook plugin, check out <em>CaptainHook\App\Plugin\Hook\PreserveWorkingTree</em>.
      </p>

      <pre><code class="php">&lt;?php

namespace MyName\GitHook;

use CaptainHook\App\Config;
use CaptainHook\App\Plugin;
use CaptainHook\App\Runner\Hook as RunnerHook;

class MyPlugin extends Plugin\Hook\Base implements Plugin\Hook
{
    /**
     * Runs before the hook.
     *
     * @param RunnerHook $hook This is the current hook that's running.
     */
    public function beforeHook(RunnerHook $hook): void
    {
        $stuff = $this->plugin->getOptions()->get('stuff');
        $this->io->write("Do {$stuff} before {$hook->getName()} runs");
    }

    /**
     * Runs before each action.
     *
     * @param RunnerHook $hook This is the current hook that's running.
     * @param Config\Action $action This is the configuration for action that will
     *                              run immediately following this method.
     */
    public function beforeAction(RunnerHook $hook, Config\Action $action): void
    {
        $this->io->write("Do stuff before action {$action->getAction()} runs");
    }

    /**
     * Runs after each action.
     *
     * @param RunnerHook $hook This is the current hook that's running.
     * @param Config\Action $action This is the configuration for action that just
     *                              ran immediately before this method.
     */
    public function afterAction(RunnerHook $hook, Config\Action $action): void
    {
        $this->io->write("Do stuff after action {$action->getAction()} runs");
    }

    /**
     * Runs after the hook.
     *
     * @param RunnerHook $hook This is the current hook that's running.
     */
    public function afterHook(RunnerHook $hook): void
    {
        $this->io->write("Do stuff after {$hook->getName()} runs");
    }
}</code></pre>

      <h3 id="constrained">Hook Constrained</h3>

      <p>
        It is possible that your <em>Actions</em>, <em>Conditions</em>, or <em>Plugins</em> are only applicable for
        certain hooks. For example CaptainHook's commit message validation hooks are only applicable for the
        <em>commit-message</em> hook. If you want to constrain your <em>Actions</em>, <em>Conditions</em>, or
        <em>Plugins</em> to specific hooks, you can implement the <em>Constrained</em> interface and implement the
        required <em>getRestrictions</em> method.
      </p>
      <p>
        In the following example the condition will only be executed during <em>pre-commit</em> hooks.
      </p>

      <pre><code class="php">&lt;?php

namespace MyName\HookConditions;

use CaptainHook\App\Console\IO;
use CaptainHook\App\Hook\Condition;
use CaptainHook\App\Hook\Constrained;
use CaptainHook\App\Hook\Restriction;
use SebastianFeldmann\Git\Repository;

class RandomFail implements Condition, Constrained
{
    /**
     * Return the hook restriction information
     *
     * @return \CaptainHook\App\Hook\Restriction
     */
    public static function getRestriction(): Restriction
    {
        return Restriction::fromArray([Hooks::PRE_COMMIT]);
    }

    /**
     * Fail 50% of the time randomly ;)
     *
     * @param  \CaptainHook\App\Console\IO       $io
     * @param  \SebastianFeldmann\Git\Repository $repository
     * @return bool
     */
    public function isTrue(IO $io, Repository $repository) : bool
    {
        return rand(0, 10)%2 === 0;
    }
}</code></pre>

      <h3 id="extensions">Third-party Extensions</h3>

      <p>
        Third-party extensions are composer installable packages of curated <em>CaptainHook</em> <em>Actions</em>,
        <em>Rules</em>, <em>Conditions</em>, or <em>Plugins</em>. After installing an extension via composer you should
        be able to reference those in your <em>CaptainHook</em> configuration.
      </p>

      <p>
        This is the list of known extensions in alphabetical order. If you want to add your extension just open a pull
        request on github or drop me a line via twitter. I will happily add it to the list.
      </p>

      <ul>
        <li><a href="https://github.com/ramsey/conventional-commits">conventional commits</a> <span>by Ben Ramsey</span></li>
        <li><a href="https://github.com/Moxio/captainhook-eslint">ESLint</a> <span>by Moxio</span></li>
        <li><a href="https://github.com/bitExpert/captainhook-infection">Infection</a> <span>by bitExpert</span></li>
        <li><a href="https://github.com/bitExpert/captainhook-rejectpush">Reject Push</a> <span>by bitExpert</span></li>
        <li><a href="https://github.com/bitExpert/captainhook-validateauthor">Validate Author</a> <span>by bitExpert</span></li>
        <li><a href="https://github.com/boesing/captainhook-vendor-resolver">Vendor Resolver</a> <span>by Maximilian B.</span></li>
      </ul>

      <p>
        Thanks to all the extension maintainers!
      </p>

    </div>

    <footer class="footer">
      <div class="container">
        <p>
          Found a typo or a bug?
          Please open an <a href="https://github.com/captainhook-git/captainhook/issues">issue</a>
          or pull request for the <em>gh-pages</em>
          branch of <a href="https://github.com/captainhook-git/captainhook/tree/gh-pages">CaptainHook</a>
        </p>
        <p>
          &copy; <a href="https://github.com/sebastianfeldmann">Sebastian Feldmann</a>
        </p>
      </div>
    </footer>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
  </body>
</html>
